/* ==============================================
   YOYAKU PLAYER V3 - IPHONE SAFARI FIX 2024
   CORRECTIONS CRITIQUES POUR COMPATIBILITÉ
   ============================================== */

/* SUPPRIMÉ: @viewport deprecated - NE FONCTIONNE PLUS */
/* @viewport est mort en 2024 - utiliser meta tag HTML uniquement */

/* ==============================================
   MEDIA QUERIES CORRIGÉES - SYNTAXE 2024
   ============================================== */

/* AVANT (CASSÉ): max-device-width deprecated */
/* APRÈS (CORRIGÉ): max-width seulement */

/* iPhone ALL MODELS - Syntaxe corrigée 2024 */
@media screen and (max-width: 430px) and (-webkit-min-device-pixel-ratio: 2),
       screen and (max-width: 390px) and (-webkit-min-device-pixel-ratio: 3),
       screen and (max-width: 375px) and (-webkit-min-device-pixel-ratio: 2),
       screen and (max-width: 414px) and (-webkit-min-device-pixel-ratio: 3) {
    
    /* FORCE LAYOUT 2 LIGNES IPHONE */
    .yoyaku-player-ultra-fin {
        height: 110px !important;
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100vw !important;
        transform: translateY(0) !important;
        z-index: 999999 !important;
        background: #2d2d2d !important;
        box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.8) !important;
        
        /* FIX CSS GRID + FIXED POSITION BUG iOS */
        contain: layout style !important;
        will-change: transform !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
    }
    
    .yoyaku-player-ultra-fin .player-inner {
        height: 110px !important;
        /* CORRIGÉ: CSS Grid optimisé pour iOS Safari */
        display: -webkit-grid !important;
        display: grid !important;
        grid-template-rows: 55px 55px !important;
        grid-template-columns: 50px 1fr 120px 40px !important;
        grid-template-areas: 
            "vinyl metadata controls cart"
            "vinyl waveform waveform waveform" !important;
        gap: 0 !important;
        padding: 3px !important;
        align-items: center !important;
        
        /* iOS Safari Grid performance fixes */
        -webkit-overflow-scrolling: touch !important;
        overflow: hidden !important;
    }
    
    /* VINYL - Grid area fix */
    .yoyaku-player-ultra-fin .vinyl-cover {
        grid-area: vinyl !important;
        grid-row: 1 / 3 !important;
        width: 45px !important;
        height: 104px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex-shrink: 0 !important;
        
        /* iOS Safari hardware acceleration */
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
    }
    
    /* LIGNE 2: WAVEFORM - iOS Safari overflow fix */
    .yoyaku-player-ultra-fin .waveform-container {
        grid-area: waveform !important;
        grid-column: 2 / -1 !important;
        width: calc(100vw - 55px) !important;
        height: 45px !important;
        margin: 3px 5px 3px 3px !important;
        background: rgba(45,45,45,0.9) !important;
        border-radius: 22px !important;
        
        /* FIX iOS Safari overflow: auto bug */
        overflow: hidden !important; /* Changé de auto à hidden */
        -webkit-overflow-scrolling: auto !important; /* Disable momentum scrolling */
        
        min-width: auto !important;
        border: 1px solid #666 !important;
        position: relative !important;
        flex: none !important;
    }
    
    /* Touch optimizations iOS Safari 2024 */
    .yoyaku-player-ultra-fin .control-btn,
    .yoyaku-player-ultra-fin .cart-btn,
    .yoyaku-player-ultra-fin .waveform-container {
        -webkit-tap-highlight-color: transparent !important;
        -webkit-touch-callout: none !important;
        -webkit-user-select: none !important;
        user-select: none !important;
        
        /* iOS 17+ touch improvements */
        touch-action: manipulation !important;
    }
    
    /* Body padding - Fix pour iOS Safari avec toolbar */
    body {
        padding-bottom: 110px !important;
        /* iOS Safari dynamic viewport fix */
        padding-bottom: calc(110px + env(safe-area-inset-bottom)) !important;
    }
}

/* ==============================================
   DÉTECTION AMÉLIORÉE iOS DEVICES
   ============================================== */

/* Utilise supports() pour détecter iOS Safari spécifiquement */
@supports (-webkit-touch-callout: none) {
    /* Code spécifique iOS Safari */
    .yoyaku-player-ultra-fin {
        /* Fix iOS Safari specific bugs */
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
    }
}

/* iPhone 15/16 Pro Max et nouveaux modèles */
@media screen and (max-width: 430px) and (min-resolution: 3dppx) {
    .yoyaku-player-ultra-fin {
        /* Spécial iPhone 15/16 Pro Max */
        height: 115px !important;
    }
    
    body {
        padding-bottom: 115px !important;
        padding-bottom: calc(115px + env(safe-area-inset-bottom)) !important;
    }
}

/* ==============================================
   FALLBACKS SI GRID NE FONCTIONNE PAS
   ============================================== */

/* Fallback Flexbox si CSS Grid échoue */
@supports not (display: grid) {
    .yoyaku-player-ultra-fin .player-inner {
        display: -webkit-flex !important;
        display: flex !important;
        flex-direction: column !important;
        height: 110px !important;
    }
    
    .yoyaku-player-ultra-fin .vinyl-cover {
        position: absolute !important;
        left: 5px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
    }
    
    .yoyaku-player-ultra-fin .waveform-container {
        margin-left: 60px !important;
        margin-top: 55px !important;
    }
}

/* ==============================================
   DEBUGGING HELPERS
   ============================================== */

.debug-iphone-viewport {
    position: fixed;
    top: 0;
    left: 0;
    background: rgba(255, 0, 0, 0.9);
    color: white;
    padding: 5px;
    font-size: 10px;
    z-index: 9999999;
    font-family: monospace;
}

.debug-iphone-viewport::after {
    content: "vw:" attr(data-vw) " vh:" attr(data-vh) " dpr:" attr(data-dpr);
}

/* Ajouter via JS pour debug:
document.body.insertAdjacentHTML('afterbegin', 
  '<div class="debug-iphone-viewport" data-vw="' + window.innerWidth + 
  '" data-vh="' + window.innerHeight + 
  '" data-dpr="' + window.devicePixelRatio + '"></div>');
*/